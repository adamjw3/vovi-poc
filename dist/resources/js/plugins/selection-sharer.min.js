!function(s){function i(e){var a=this;"string"==typeof(e=e||{})&&(e={elements:e}),this.sel=null,this.textSelection="",this.htmlSelection="",this.appId=s('meta[property="fb:app_id"]').attr("content")||s('meta[property="fb:app_id"]').attr("value"),this.url2share=s('meta[property="og:url"]').attr("content")||s('meta[property="og:url"]').attr("value")||window.location.href,this.getSelectionText=function(e){var t="",o="";if((e=e||window.getSelection()).rangeCount){for(var n=document.createElement("div"),i=0,r=e.rangeCount;i<r;++i)n.appendChild(e.getRangeAt(i).cloneContents());o=n.textContent,t=n.innerHTML}return a.textSelection=o,a.htmlSelection=t||o,o},this.selectionDirection=function(e){var t=e||window.getSelection(),e=document.createRange();if(!t.anchorNode)return 0;e.setStart(t.anchorNode,t.anchorOffset),e.setEnd(t.focusNode,t.focusOffset);t=e.collapsed?"backward":"forward";return e.detach(),t},this.show=function(r){setTimeout(function(){var e=window.getSelection(),t=a.getSelectionText(e);if(!e.isCollapsed&&t&&10<t.length&&t.match(/ /)){var o=e.getRangeAt(0).getBoundingClientRect().top-5+a.getPosition().y-a.$popover.height(),n=0;if(r)n=r.pageX;else{var i=e.anchorNode.parentNode;for(n+=i.offsetWidth/2;n+=i.offsetLeft,i=i.offsetParent;);}switch(a.selectionDirection(e)){case"forward":n-=a.$popover.width();break;case"backward":n+=a.$popover.width();break;default:return}a.$popover.removeClass("anim").css("top",10+o).css("left",n).show(),setTimeout(function(){a.$popover.addClass("anim").css("top",o)},0)}},10)},this.hide=function(e){a.$popover.hide()},this.smart_truncate=function(e,t){if(!e||!e.length)return e;var o=e.length>t,e=o?e.substr(0,t-1):e,e=o?e.substr(0,e.lastIndexOf(" ")):e;return o?e+"...":e},this.getRelatedTwitterAccounts=function(){var e=[],t=s('meta[name="twitter:creator"]').attr("content")||s('meta[name="twitter:creator"]').attr("value");t&&e.push(t);for(var o,n=document.getElementsByTagName("a"),i=0,r=n.length;i<r;i++)!n[i].attributes.href||"string"!=typeof n[i].attributes.href.value||(o=n[i].attributes.href.value.match(/^https?:\/\/twitter\.com\/([a-z0-9_]{1,20})/i))&&1<o.length&&-1==["widgets","intent"].indexOf(o[1])&&e.push(o[1]);return 0<e.length?e.join(","):""},this.shareTwitter=function(e){e.preventDefault();var t="“"+a.smart_truncate(a.textSelection.trim(),114)+"”",o="http://twitter.com/intent/tweet?text="+encodeURIComponent(t)+"&related="+a.relatedTwitterAccounts+"&url="+encodeURIComponent(window.location.href);a.viaTwitterAccount&&t.length<114-a.viaTwitterAccount.length&&(o+="&via="+a.viaTwitterAccount);e=screen.width/2-320,t=screen.height/2-220-100;return window.open(o,"share_twitter","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=640, height=440, top="+t+", left="+e),a.hide(),!1},this.shareFacebook=function(e){e.preventDefault();var t=a.htmlSelection.replace(/<p[^>]*>/gi,"\n").replace(/<\/p>|  /gi,"").trim(),o="https://www.facebook.com/dialog/feed?app_id="+a.appId+"&display=popup&caption="+encodeURIComponent(t)+"&link="+encodeURIComponent(a.url2share)+"&href="+encodeURIComponent(a.url2share)+"&redirect_uri="+encodeURIComponent(a.url2share),e=screen.width/2-320,t=screen.height/2-220-100;window.open(o,"share_facebook","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=640, height=440, top="+t+", left="+e)},this.render=function(){a.$popover=s('<div class="selectionSharer" id="selectionSharerPopover" style="position:absolute;">  <div id="selectionSharerPopover-inner">    <ul>      <li><a class="action tweet" href="" title="Share this selection on Twitter" target="_blank">Tweet</a></li>      <li><a class="action facebook" href="" title="Share this selection on Facebook" target="_blank">Facebook</a></li>    </ul>  </div>  <div class="selectionSharerPopover-clip"><span class="selectionSharerPopover-arrow"></span></div></div>'),a.$popover.find("a.tweet").click(a.shareTwitter),a.$popover.find("a.facebook").click(a.shareFacebook),s("body").append(a.$popover),a.appId&&a.url2share&&s(".selectionSharer a.facebook").css("display","inline-block")},this.setElements=function(e){"string"==typeof e&&(e=s(e)),a.$elements=e instanceof s?e:s(e),a.$elements.mouseup(a.show).mousedown(a.hide).addClass("selectionShareable"),document.onselectionchange=a.selectionChanged},this.selectionChanged=function(e){},this.getPosition=function(){var e=void 0!==window.pageXOffset,t="CSS1Compat"===(document.compatMode||"");return{x:e?window.pageXOffset:(t?document.documentElement:document.body).scrollLeft,y:e?window.pageYOffset:(t?document.documentElement:document.body).scrollTop}},this.render(),e.elements&&this.setElements(e.elements)}s.fn.selectionSharer=function(){return(new i).setElements(this),this},"function"==typeof define?define(function(){return i.load=function(e,t,o,n){(new i).setElements("p"),o()},i}):window.SelectionSharer=i}(jQuery);